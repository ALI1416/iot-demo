# 物联网协议

## 通信主题

### MQTT

- 事件(嵌入式 --> 后端)
`$iot/event/网关序号/设备序号/命令代码`
- 故障(嵌入式 --> 后端)
`$iot/fault/网关序号/设备序号/命令代码`
- 互动
  - 请求(后端 --> 嵌入式)
`$iot/request/网关序号/设备序号/命令代码/请求序号`
  - 响应(嵌入式 --> 后端)
`$iot/response/网关序号/设备序号/命令代码/请求序号/错误代码`

- 备注1：网关收发消息，设备序号使用0
- 备注2：嵌入式通过面板修改数据，通过`互动-响应`发送给后端，请求序号使用0

### WebSocket

- 报告(广播)
  - 发送(后端)
`/topic/iot/event/网关序号/设备序号/命令代码`
  - 接收(前端)
`/topic/iot/event/网关序号/设备序号/命令代码`
- 故障(广播)
  - 发送(后端)
`/topic/iot/fault/网关序号`
  - 接收(前端)
`/topic/iot/fault/网关序号`
- 互动(广播)
  - 发送(后端)
`/topic/iot/interact/网关序号/设备序号/命令代码`
  - 接收(前端)
`/topic/iot/interact/网关序号/设备序号/命令代码`

## 数据类型

| 中文名     | 类型名  | 字节数 | 取值范围       |
| ---------- | ------- | ------ | -------------- |
| 布尔       | boolean | 1      | true/false     |
| 整型       | int     | 4      | -2^31 ~ 2^31-1 |
| 长整型     | long    | 8      | -2^63 ~ 2^63-1 |
| 双精度浮点 | double  | 8      | -              |
| 字符串     | string  | -      | -              |

## 参数格式

- 命令代码 int(非负)
  - 报告 1xxx
  - 故障 2xxx
  - 设置参数 3xxx
  - 获取参数 4xxx
  - 获取实时报告 5xxx
  - 获取实时故障 6xxx
- 网关序号 int(非负)
- 设备序号 int(非负)
- 请求序号 long(非负)
- 错误代码 int(非负)
  - 0 没有错误
  - 1 主题错误
  - 2 消息错误
  - 3 执行失败

## 命令格式

### 报告

#### Event1000 心跳

`$iot/event/1000/网关序号/0`

#### Event1001 网关

`$iot/event/1001/网关序号/0`

---

- 设备列表 deviceList list
  - 设备序号 sn int
  - 设备类型 type int

---

#### Event1002 温湿度

`$iot/event/1002/网关序号/设备序号`

---

- 温度(m℃ 毫摄氏度) temperature int
- 湿度(%% 万分之) humidity int

---

### 故障

#### Fault2002 温湿度

`$iot/fault/2002/网关序号/设备序号`

---

1. 报警
   1. 温度过高
   2. 温度过低
   3. 湿度过高
   4. 湿度过低

---

### 交互

#### Interact3001 设置通信地址

请求 `$iot/request/3001/网关序号/0/请求序号`

---

- URI uri string
- 用户名 username string
- 密码 password string

---

响应 `$iot/response/3001/网关序号/0/请求序号/错误代码`

#### Interact3002 设置温湿度报警

请求 `$iot/request/3002/网关序号/设备序号/请求序号`

---

- 温度上限(m℃ 毫摄氏度) temperatureMax int
- 温度下限(m℃ 毫摄氏度) temperatureMin int
- 湿度上限(%% 万分之) humidityMax int
- 湿度下限(%% 万分之) humidityMin int

---

响应 `$iot/response/3002/网关序号/设备序号/请求序号/错误代码`

#### Interact4001 获取通信地址

请求 `$iot/request/4001/网关序号/0/请求序号`

响应 `$iot/response/4001/网关序号/0/请求序号/错误代码`

响应结果见[Interact3001 设置通信地址](#interact3001-设置通信地址)

#### Interact4002 获取温湿度报警

请求 `$iot/request/4002/网关序号/设备序号/请求序号`

响应 `$iot/response/4002/网关序号/设备序号/请求序号/错误代码`

响应结果见[Interact3001 设置温湿度报警](#interact3002-设置温湿度报警)
