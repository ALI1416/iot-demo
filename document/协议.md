# 物联网协议

## 通信主题

### MQTT

- 事件(嵌入式 --> 后端)
`$iot/event/网关序号/设备序号/命令代码`
- 故障(嵌入式 --> 后端)
`$iot/fault/网关序号/设备序号/命令代码`
- 互动
  - 请求(后端 --> 嵌入式)
`$iot/request/网关序号/设备序号/命令代码/请求序号`
  - 响应(嵌入式 --> 后端)
`$iot/response/网关序号/设备序号/命令代码/请求序号/错误代码`

- 备注1：网关收发消息，`设备序号`使用`0`
- 备注2：嵌入式设备通过面板修改数据，通过`互动-响应`发送给后端，`请求序号`使用`0`

### WebSocket

- 事件(广播)
  - 发送(后端)
`/topic/iot/event/网关序号/设备序号/命令代码`
  - 接收(前端)
`/topic/iot/event/网关序号/设备序号/命令代码`
- 故障(广播)
  - 发送(后端)
`/topic/iot/fault/网关序号`
  - 接收(前端)
`/topic/iot/fault/网关序号`
- 互动(广播)
  - 发送(后端)
`/topic/iot/interact/网关序号/设备序号/命令代码`
  - 接收(前端)
`/topic/iot/interact/网关序号/设备序号/命令代码`

## 数据类型

| 中文名     | 类型名  | 字节数 | 取值范围       |
| ---------- | ------- | ------ | -------------- |
| 布尔       | boolean | 1      | true/false     |
| 整型       | int     | 4      | -2^31 ~ 2^31-1 |
| 长整型     | long    | 8      | -2^63 ~ 2^63-1 |
| 双精度浮点 | double  | 8      | -              |
| 字符串     | string  | -      | -              |

## 参数格式

- 命令代码 int(非负) 5位
  - 类型 1位
    - 1 事件
    - 2 故障
    - 3 设置参数
    - 4 获取参数
    - 5 获取实时事件
    - 6 获取实时故障
  - 设备 2位
    - 00 网关
    - 01 温度计
  - 协议 2位
- 网关序号 int(非负)
- 设备序号 int(非负)
- 请求序号 long(非负)
- 错误代码 int(非负)
  - 0 没有错误
  - 1 主题错误
  - 2 消息错误
  - 3 执行失败

## 命令格式

### 事件

#### Event10100 温度计事件

`$iot/event/10100/网关序号/设备序号`

---

- 温度(m℃ 毫摄氏度) temperature int

---

### 故障

#### Fault20100 温度计故障

`$iot/fault/20100/网关序号/设备序号`

---

1. 报警
   1. 温度过高
   2. 温度过低

---

### 交互

#### Interact30000 设置网关通信地址

请求 `$iot/request/30000/网关序号/0/请求序号`

---

- URI uri string
- 用户名 username string
- 密码 password string

---

响应 `$iot/response/30000/网关序号/0/请求序号/错误代码`

#### Interact30100 设置温度计参数

请求 `$iot/request/30100/网关序号/设备序号/请求序号`

---

- 刷新间隔(s 秒) intervalRefresh int
- 推送间隔(s 秒) intervalPush int
- 温度上限(m℃ 毫摄氏度) temperatureMax int
- 温度下限(m℃ 毫摄氏度) temperatureMin int

---

响应 `$iot/response/30100/网关序号/设备序号/请求序号/错误代码`

#### Interact40000 获取网关通信地址

请求 `$iot/request/40000/网关序号/0/请求序号`

响应 `$iot/response/40000/网关序号/0/请求序号/错误代码`

响应结果见[Interact30000 设置网关通信地址](#interact30000-设置网关通信地址)

#### Interact40001 获取网关信息

请求 `$iot/request/40001/网关序号/0`

响应 `$iot/response/40001/网关序号/0/请求序号/错误代码`

---

- 设备列表 deviceList list
  - 设备序号 sn int
  - 设备类型 type int

---

#### Interact40100 获取温度计参数

请求 `$iot/request/40100/网关序号/设备序号/请求序号`

响应 `$iot/response/40100/网关序号/设备序号/请求序号/错误代码`

响应结果见[Interact30100 设置温度计参数](#interact30100-设置温度计参数)
